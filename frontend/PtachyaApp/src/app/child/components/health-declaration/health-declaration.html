<div class="declaration-container">
  <h2 class="title">📄 הצהרה על קבלת "טיפול בריאותי מקדם" (טב"ם)</h2>
  
  <form [formGroup]="healthDeclarationForm" (ngSubmit)="onSubmit()" dir="rtl">
    
    <div class="form-group full-width" style="margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
        <label for="formDate">תאריך מילוי הטופס (היום) *</label>
        <input id="formDate" type="date" formControlName="formDate" readonly class="read-only-input">
    </div>

    <fieldset formGroupName="childDetails">
      <legend><h3>פרטי הילד/ה</h3></legend>
      <p>אני פונה בבקשה לשלב את בני/בתי בתכנית "טיפול בריאותי מקדם".</p>

      <div class="form-row">
        <div class="form-group">
          <label for="childFirstName">שם פרטי *</label>
          <input id="childFirstName" type="text" formControlName="childFirstName" [class.is-invalid]="f['childDetails'].get('childFirstName')?.invalid && (f['childDetails'].get('childFirstName')?.dirty || f['childDetails'].get('childFirstName')?.touched || submitted)">
          <div *ngIf="f['childDetails'].get('childFirstName')?.invalid && (f['childDetails'].get('childFirstName')?.dirty || f['childDetails'].get('childFirstName')?.touched || submitted)" class="error-message">
            שם פרטי נדרש.
          </div>
        </div>
        
        <div class="form-group">
          <label for="childLastName">שם משפחה *</label>
          <input id="childLastName" type="text" formControlName="childLastName" [class.is-invalid]="f['childDetails'].get('childLastName')?.invalid && (f['childDetails'].get('childLastName')?.dirty || f['childDetails'].get('childLastName')?.touched || submitted)">
          <div *ngIf="f['childDetails'].get('childLastName')?.invalid && (f['childDetails'].get('childLastName')?.dirty || f['childDetails'].get('childLastName')?.touched || submitted)" class="error-message">
            שם משפחה נדרש.
          </div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="childId">מס' ת"ז *</label>
          <input id="childId" type="text" formControlName="childId" [class.is-invalid]="f['childDetails'].get('childId')?.invalid && (f['childDetails'].get('childId')?.dirty || f['childDetails'].get('childId')?.touched || submitted)">
          <div *ngIf="f['childDetails'].get('childId')?.invalid && (f['childDetails'].get('childId')?.dirty || f['childDetails'].get('childId')?.touched || submitted)" class="error-message">
            נדרש מס' ת"ז תקין (9 ספרות).
          </div>
        </div>
        
        <div class="form-group">
          <label for="childDob">תאריך לידה *</label>
          <input id="childDob" type="date" formControlName="childDob" [class.is-invalid]="f['childDetails'].get('childDob')?.invalid && (f['childDetails'].get('childDob')?.dirty || f['childDetails'].get('childDob')?.touched || submitted)">
          <div *ngIf="f['childDetails'].get('childDob')?.invalid && (f['childDetails'].get('childDob')?.dirty || f['childDetails'].get('childDob')?.touched || submitted)" class="error-message">
            תאריך לידה נדרש.
          </div>
        </div>
      </div>

      <div class="form-group full-width">
        <label for="childAddress">מתגורר/ת בכתובת *</label>
        <input id="childAddress" type="text" formControlName="childAddress" [class.is-invalid]="f['childDetails'].get('childAddress')?.invalid && (f['childDetails'].get('childAddress')?.dirty || f['childDetails'].get('childAddress')?.touched || submitted)">
        <div *ngIf="f['childDetails'].get('childAddress')?.invalid && (f['childDetails'].get('childAddress')?.dirty || f['childDetails'].get('childAddress')?.touched || submitted)" class="error-message">
          כתובת מגורים נדרשת.
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend><h3>פרטי תכנית ועלויות</h3></legend>
      
      <div class="form-group full-width">
        <label for="programProvider">הניתנת ע"י *</label>
        <input id="programProvider" type="text" formControlName="programProvider" [class.is-invalid]="f['programProvider']?.invalid && (f['programProvider']?.dirty || f['programProvider']?.touched || submitted)">
        <div *ngIf="f['programProvider']?.invalid && (f['programProvider']?.dirty || f['programProvider']?.touched || submitted)" class="error-message">
          שם הגורם המטפל נדרש.
        </div>
      </div>

      <div class="form-group full-width radio-group-container">
        <label>במסגרת *</label>
        <div class="radio-group">
          <label><input type="radio" formControlName="programFramework" value="גן תקשורתי"> גן תקשורתי</label>
          <label><input type="radio" formControlName="programFramework" value="מרכז טיפולי"> מרכז טיפולי</label>
        </div>
        <div *ngIf="f['programFramework']?.invalid && (f['programFramework']?.dirty || f['programFramework']?.touched || submitted)" class="error-message">
          יש לסמן את סוג המסגרת.
        </div>
      </div>
    </fieldset>
    
    <fieldset formGroupName="facilityDetails">
      <legend><h3>פרטי המסגרת (גן/מרכז הטיפול)</h3></legend>
      
      <div class="form-group full-width">
        <label for="facilityName">שם המסגרת *</label>
        <input id="facilityName" type="text" formControlName="facilityName" [class.is-invalid]="f['facilityDetails'].get('facilityName')?.invalid && submitted">
        <div *ngIf="f['facilityDetails'].get('facilityName')?.invalid && submitted" class="error-message">
          שם המסגרת נדרש.
        </div>
      </div>

      <div class="form-group full-width radio-group-container">
        <label>בעלות *</label>
        <div class="radio-group">
          <label><input type="radio" formControlName="facilityOwnership" value="רשות מקומית"> רשות מקומית</label>
          <label><input type="radio" formControlName="facilityOwnership" value="בעלות פרטית עמותה"> בעלות פרטית עמותה</label>
        </div>
        <div *ngIf="f['facilityDetails'].get('facilityOwnership')?.invalid && submitted" class="error-message">
          יש לסמן את הבעלות על המסגרת.
        </div>
      </div>

      <div class="form-group full-width">
        <label for="facilityManagerName">שם מנהל המסגרת *</label>
        <input id="facilityManagerName" type="text" formControlName="facilityManagerName" [class.is-invalid]="f['facilityDetails'].get('facilityManagerName')?.invalid && submitted">
        <div *ngIf="f['facilityDetails'].get('facilityManagerName')?.invalid && submitted" class="error-message">
          שם מנהל המסגרת נדרש.
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="facilityAddress">כתובת המסגרת *</label>
          <input id="facilityAddress" type="text" formControlName="facilityAddress" [class.is-invalid]="f['facilityDetails'].get('facilityAddress')?.invalid && submitted">
          <div *ngIf="f['facilityDetails'].get('facilityAddress')?.invalid && submitted" class="error-message">
            כתובת המסגרת נדרשת.
          </div>
        </div>
        
        <div class="form-group">
          <label for="facilityPhone">מס' הטלפון *</label>
          <input id="facilityPhone" type="tel" formControlName="facilityPhone" [class.is-invalid]="f['facilityDetails'].get('facilityPhone')?.invalid && submitted">
          <div *ngIf="f['facilityDetails'].get('facilityPhone')?.invalid && submitted" class="error-message">
            מספר טלפון תקין נדרש.
          </div>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend><h3>השתתפות עצמית והצהרות</h3></legend>
      
      <div class="form-group full-width">
        <label for="monthlySelfParticipation">ידוע לי כי קבלת השירות כרוכה בהשתתפות עצמית חודשית, העומדת על (₪) *</label>
        <input id="monthlySelfParticipation" type="number" formControlName="monthlySelfParticipation" [class.is-invalid]="f['monthlySelfParticipation']?.invalid && submitted">
        <div *ngIf="f['monthlySelfParticipation']?.invalid && submitted" class="error-message">
          סכום השתתפות עצמית חודשית נדרש.
        </div>
      </div>

      <div class="form-group full-width checkbox-group">
        <label>
          <input type="checkbox" formControlName="noOtherProgramDeclaration">
          אני מצהיר/ה כי בני/בתי אינו/ה מקבל/ת תכנית "טיפול בריאותי מקדם" בתקצוב משרד הבריאות בשום מסגרת אחרת. *
        </label>
        <div *ngIf="f['noOtherProgramDeclaration']?.invalid && submitted" class="error-message">
          יש לאשר הצהרה זו.
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend><h3>פרטי הורים/אפוטרופוס (חתימת הורה 1 חובה)</h3></legend>
      
      <div formGroupName="parent1" class="parent-section">
        <h4>הורה/אפוטרופוס 1 (חובה)</h4>
        <div class="form-row">
          <div class="form-group">
            <label for="p1Name">שם מלא *</label>
            <input id="p1Name" type="text" formControlName="name" [class.is-invalid]="f['parent1'].get('name')?.invalid && submitted">
            <div *ngIf="f['parent1'].get('name')?.invalid && submitted" class="error-message">
              שם מלא נדרש.
            </div>
          </div>
          <div class="form-group">
            <label for="p1Phone">מספר טלפון *</label>
            <input id="p1Phone" type="tel" formControlName="phone" [class.is-invalid]="f['parent1'].get('phone')?.invalid && submitted">
            <div *ngIf="f['parent1'].get('phone')?.invalid && submitted" class="error-message">
              מספר טלפון תקין נדרש.
            </div>
          </div>
        </div>
        
        <div class="signature-pad-container">
            <label>חתימה דיגיטלית (צייר עם העכבר/אצבע) *</label>
            <canvas #parent1SignatureCanvas 
                    class="signature-canvas"
                    width="350" 
                    height="100"
                    (mousedown)="startDrawing(ctx1, $event)"
                    (mousemove)="draw(ctx1, $event)"
                    (mouseup)="stopDrawing(1)"
                    (mouseleave)="stopDrawing(1)"
                    (touchstart)="startDrawing(ctx1, $event)"
                    (touchmove)="draw(ctx1, $event)"
                    (touchend)="stopDrawing(1)"
            ></canvas>
            <button type="button" class="clear-button" (click)="clearSignature(1)">נקה חתימה</button>
            <input type="hidden" formControlName="signature">
            <div *ngIf="f['parent1'].get('signature')?.invalid && submitted" class="error-message">
                חתימת הורה 1 נדרשת.
            </div>
        </div>
        
        <div class="signature-mock date-only">
            <p><span>תאריך: {{ healthDeclarationForm.get('formDate')?.value | date:'dd/MM/yyyy' }}</span></p>
        </div>
      </div>

      <hr>

      <div formGroupName="parent2" class="parent-section">
        <h4>הורה/אפוטרופוס 2 (אופציונלי)</h4>
        <div class="form-row">
          <div class="form-group">
            <label for="p2Name">שם מלא</label>
            <input id="p2Name" type="text" formControlName="name">
          </div>
          <div class="form-group">
            <label for="p2Phone">מספר טלפון</label>
            <input id="p2Phone" type="tel" formControlName="phone" [class.is-invalid]="f['parent2'].get('phone')?.value && f['parent2'].get('phone')?.invalid">
            <div *ngIf="f['parent2'].get('phone')?.value && f['parent2'].get('phone')?.invalid" class="error-message">
              מספר טלפון תקין נדרש.
            </div>
          </div>
        </div>
        
        <div class="signature-pad-container">
            <label>חתימה דיגיטלית (צייר עם העכבר/אצבע)</label>
            <canvas #parent2SignatureCanvas 
                    class="signature-canvas"
                    width="350" 
                    height="100"
                    (mousedown)="startDrawing(ctx2, $event)"
                    (mousemove)="draw(ctx2, $event)"
                    (mouseup)="stopDrawing(2)"
                    (mouseleave)="stopDrawing(2)"
                    (touchstart)="startDrawing(ctx2, $event)"
                    (touchmove)="draw(ctx2, $event)"
                    (touchend)="stopDrawing(2)"
            ></canvas>
            <button type="button" class="clear-button" (click)="clearSignature(2)">נקה חתימה</button>
            <input type="hidden" formControlName="signature">
        </div>
        
        <div class="signature-mock date-only">
            <p><span>תאריך: {{ healthDeclarationForm.get('formDate')?.value | date:'dd/MM/yyyy' }}</span></p>
        </div>
      </div>
    </fieldset>

    <div class="actions">
      <button type="submit" class="submit-button">שלח טופס</button>
      <button type="button" class="reset-button" (click)="onReset()">אפס טופס</button>
    </div>
  </form>

  <div *ngIf="submitted && healthDeclarationForm.invalid" class="form-summary-error">
    🔴 נא תקן את השגיאות המסומנות בטופס לפני השליחה.
  </div>
</div>